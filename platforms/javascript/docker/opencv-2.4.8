FROM emscripten
# This docker files compiles and install opencv 2.4.9 with emscripten1.16.0

# Fetch and extract opencv's tar ball
RUN wget -O/tmp/opencv.tar.gz https://github.com/Itseez/opencv/archive/2.4.8.2.tar.gz
RUN tar -C /usr/local/src -xzf /tmp/opencv.tar.gz

# Finally, we're ready to cross-compile opencv
RUN mkdir /usr/local/src/opencv-2.4.8.2/build-js
WORKDIR /usr/local/src/opencv-2.4.8.2/build-js

# Disabling every option except BUILD_SHARED_LIBS BUILD_opencv_calib3d BUILD_opencv_core BUILD_opencv_features2d BUILD_opencv_flann BUILD_opencv_highgui BUILD_opencv_imgproc and ENABLE_OMIT_FRAME_POINTER
RUN emconfigure cmake \
    -DCMAKE_CXX_FLAGS="-O2 -DNDEBUG" \
    -DCMAKE_INSTALL_PREFIX=$EMSCRIPTEN_ROOT/system \
    -DBUILD_DOCS=OFF\
    -DBUILD_EXAMPLES=OFF\
    -DBUILD_JASPER=OFF\
    -DBUILD_JPEG=OFF\
    -DBUILD_OPENEXR=OFF\
    -DBUILD_PACKAGE=OFF\
    -DBUILD_PERF_TESTS=OFF\
    -DBUILD_PNG=OFF\
    -DBUILD_SHARED_LIBS=ON\
    -DBUILD_TBB=OFF\
    -DBUILD_TESTS=OFF\
    -DBUILD_TIFF=OFF\
    -DBUILD_WITH_DEBUG_INFO=OFF\
    -DBUILD_ZLIB=OFF\
    -DBUILD_opencv_apps=OFF\
    -DBUILD_opencv_calib3d=ON\
    -DBUILD_opencv_contrib=OFF\
    -DBUILD_opencv_core=ON\
    -DBUILD_opencv_features2d=ON\
    -DBUILD_opencv_flann=ON\
    -DBUILD_opencv_gpu=OFF\
    -DBUILD_opencv_highgui=ON\
    -DBUILD_opencv_imgproc=ON\
    -DBUILD_opencv_legacy=OFF\
    -DBUILD_opencv_ml=OFF\
    -DBUILD_opencv_nonfree=OFF\
    -DBUILD_opencv_objdetect=OFF\
    -DBUILD_opencv_photo=OFF\
    -DBUILD_opencv_stitching=OFF\
    -DBUILD_opencv_superres=OFF\
    -DBUILD_opencv_ts=OFF\
    -DBUILD_opencv_video=OFF\
    -DBUILD_opencv_videostab=OFF\
    -DBUILD_opencv_world=OFF\
    -DWITH_1394=OFF\
    -DWITH_CUBLAS=OFF\
    -DWITH_CUDA=OFF\
    -DWITH_CUFFT=OFF\
    -DWITH_EIGEN=OFF\
    -DWITH_FFMPEG=OFF\
    -DWITH_GIGEAPI=OFF\
    -DWITH_GSTREAMER=OFF\
    -DWITH_GTK=OFF\
    -DWITH_JASPER=OFF\
    -DWITH_JPEG=OFF\
    -DWITH_LIBV4L=OFF\
    -DWITH_NVCUVID=OFF\
    -DWITH_OPENCL=OFF\
    -DWITH_OPENCLAMDBLAS=OFF\
    -DWITH_OPENCLAMDFFT=OFF\
    -DWITH_OPENEXR=OFF\
    -DWITH_OPENGL=OFF\
    -DWITH_OPENMP=OFF\
    -DWITH_OPENNI=OFF\
    -DWITH_PNG=OFF\
    -DWITH_PVAPI=OFF\
    -DWITH_QT=OFF\
    -DWITH_TBB=OFF\
    -DWITH_TIFF=OFF\
    -DWITH_UNICAP=OFF\
    -DWITH_V4L=OFF\
    -DWITH_XIMEA=OFF\
    -DWITH_XINE=OFF\
    -DENABLE_OMIT_FRAME_POINTER=ON\
    ..
RUN make -j4
RUN make install
